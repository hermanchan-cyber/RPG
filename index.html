<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Class RPG ‚Äî Pixel Battle (Compact + Fullscreen)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="RPG">
<style>
:root{
  --bg:#0b1220;--panel:#0f172a;--panel2:#111a2e;--text:#e5e7eb;--muted:#9ca3af;
  --primary:#3b82f6;--border:#1f2937;
  --fs:16px; --cardAvatar:150px; --barH:20px; --sprite:148px; --gridGap:10px; --logH:120px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,Inter,Roboto,Arial,sans-serif;
     display:grid;grid-template-rows:auto 1fr auto auto;gap:8px;overflow:hidden;font-size:var(--fs)}
header,footer{background:var(--panel);border-bottom:1px solid var(--border);padding:8px 10px;display:flex;align-items:center;justify-content:space-between}
h1{margin:0;font-size:calc(var(--fs) + 4px)}
.status{font-size:calc(var(--fs) - 2px);color:var(--muted)}
button{border:none;padding:7px 10px;border-radius:12px;background:#334155;color:#fff;font-size:var(--fs)}
.primary{background:var(--primary)}
.controls{display:flex;gap:6px;flex-wrap:wrap}

.grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:var(--gridGap);padding:var(--gridGap)}
.card{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:10px;
      display:grid;grid-template-columns:var(--cardAvatar) 1fr;gap:10px;transition:transform .2s,outline .2s}
.card.shrink{transform:scale(.92)}
.card.targetable{outline:2px solid #7dd3fc}
.avatar{width:var(--cardAvatar);height:var(--cardAvatar);border-radius:12px;background:#0b1229;border:1px solid #22314f;display:flex;align-items:center;justify-content:center}
.name{font-weight:900;font-size:calc(var(--fs) + 6px)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{padding:4px 8px;border-radius:999px;background:#0e162b;border:1px solid #1f274f;color:#cbd5e1;font-size:calc(var(--fs) - 2px)}

.bar{height:var(--barH);border-radius:10px;background:#0b1229;border:1px solid #1f274f;overflow:hidden;flex:1}
.fill{height:100%;width:0}
.xpfill{background:linear-gradient(90deg,#93c5fd,#3b82f6)}
.powfill{background:linear-gradient(90deg,#fca5a5,#ef4444)}
.shieldfill{background:linear-gradient(90deg,#c7d2fe,#60a5fa)}

.bag{display:flex;gap:6px;flex-wrap:wrap;min-height:28px}
.bagItem{display:flex;gap:6px;align-items:center;border:1px dashed #475569;background:#0d162c;padding:5px 8px;border-radius:10px;font-size:calc(var(--fs) - 2px)}
.empty{color:#94a3b8;font-size:calc(var(--fs) - 2px)}
.money .btn{padding:4px 8px;border-radius:10px;background:#1f2937}

.store{padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:var(--panel);border-top:1px solid var(--border)}
.sitem{display:flex;gap:8px;align-items:center;border:1px dashed #3652a1;background:#0e1736;padding:8px 10px;border-radius:10px;font-size:var(--fs)}
.sitem.selected{outline:2px solid #7dd3fc}

.log{height:var(--logH);overflow:auto;background:var(--panel);border-top:1px solid var(--border);padding:8px;font-size:calc(var(--fs) - 1px);color:#cbd5e1}

/* ===== Battle Stage ===== */
.stage{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:80}
.stage.show{display:flex}
.arena{
  width:min(900px,96vw);height:min(520px,70vh);position:relative;overflow:hidden;
  border:1px solid #1f274f;border-radius:16px;image-rendering:pixelated;
  background:linear-gradient(#87b5ff,#67a0ff 60%, #4b7fd1 61%, #4b7fd1 100%); /* sky */
}
.field{position:absolute;left:0;right:0;bottom:0;height:50%;
  background:repeating-linear-gradient(0deg,#3f7a2e 0 6px,#2f5e23 6px 12px),linear-gradient(#2a5a1f,#1f4618);
  image-rendering:pixelated;}
.actor{position:absolute;width:var(--sprite);height:var(--sprite);image-rendering:pixelated}
.actor.att{left:8px;bottom:60px}
.actor.def{right:8px;top:60px}
.actor.in{transform:translateX(0)}
.sprite{width:var(--sprite);height:var(--sprite);position:relative}

/* Status FX */
.poisoned{filter:hue-rotate(85deg) saturate(1.2) brightness(1.06)}
.charged{filter:drop-shadow(0 0 8px #ff9c3c) drop-shadow(0 0 14px #ff7733)}
.flame::after{
  content:"";position:absolute;left:50%;top:50%;width:64px;height:64px;transform:translate(-50%,-50%);
  background:radial-gradient(circle,#ffd089 0,#ff7a00 40%, rgba(255,122,0,0) 70%);border-radius:50%;
  mix-blend-mode:screen;animation:flamer 1s ease-in-out infinite
}
@keyframes flamer{0%{transform:translate(-50%,-50%) scale(.9)}50%{transform:translate(-50%,-50%) scale(1.1)}100%{transform:translate(-50%,-50%) scale(.9)}}

/* Shield UI */
.shieldIcon{position:absolute;width:84px;height:84px;left:calc(50% - 42px);top:calc(50% - 42px);opacity:.0;transform:scale(.9)}
.shieldIcon.show{opacity:.9;transition:opacity .2s}
.shieldCrack{position:absolute;inset:0;pointer-events:none;display:none}
.shieldCrack.show{display:block;animation:crack .4s ease}
@keyframes crack{0%{opacity:0}50%{opacity:1}100%{opacity:0}}

/* Stage HUD */
.stageHUD{
  position:absolute;left:50%;transform:translateX(-50%);top:6px;background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(4px);padding:6px 10px;border-radius:10px;min-width:76%;
  display:flex;gap:8px;align-items:center;justify-content:space-between;font-size:14px
}
.stageHP{flex:1;height:22px;background:#0e1b30;border:1px solid #1f274f;border-radius:12px;overflow:hidden;transform-origin:center}
.stageHP .fill{height:100%;transition:width .8s ease}
.hpPop{position:absolute;color:#fff;font-weight:800;text-shadow:0 2px 0 rgba(0,0,0,.4)}
.popDmg{color:#ffb0b0}
.popXP{color:#a6c8ff}
.popPoison{color:#b1ffb1}

/* Narration (single line) */
.narr{position:absolute;left:0;right:0;bottom:0;padding:12px;background:rgba(0,0,0,.45);
      border-top:1px solid rgba(255,255,255,.08);font-size:18px;text-align:center}
.narr .hint{font-size:12px;color:#cbd5e1}

/* Motion / Run cycle */
.runCycle{animation:runSteps .32s steps(2) infinite}
@keyframes runSteps{
  0%{filter:brightness(1)}
  50%{filter:brightness(0.92)}
  100%{filter:brightness(1)}
}
@keyframes rush { 0%{transform:translateX(0)} 50%{transform:translateX(150px)} 100%{transform:translateX(0)} }
@keyframes rushBig { 0%{transform:translateX(0) scale(1.06)} 50%{transform:translateX(220px) scale(1.1)} 100%{transform:translateX(0) scale(1)} }
@keyframes dodgeL { 0%{transform:translateX(0)} 40%{transform:translateX(-46px)} 100%{transform:translateX(0)} }
@keyframes dodgeR { 0%{transform:translateX(0)} 40%{transform:translateX(46px)} 100%{transform:translateX(0)} }
@keyframes shake { 0%,100%{transform:translate(0,0)} 25%{transform:translate(-4px,0)} 75%{transform:translate(4px,0)} }

/* Popups linger longer */
@keyframes popFloat { 0%{transform:translate(-50%,0);opacity:1} 70%{transform:translate(-50%,-30px);opacity:1} 100%{transform:translate(-50%,-48px);opacity:0} }

/* Compact mode (for iPad visibility) */
body.compact{ --fs:14px; --cardAvatar:120px; --barH:16px; --sprite:128px; --gridGap:6px; --logH:96px; }
</style>
</head>
<body>
<header>
  <h1>Class RPG ‚Äî Pixel Battle</h1>
  <div class="status">Status: <span id="status">Ready</span></div>
  <div class="controls">
    <button id="compactToggle">Compact</button>
    <button id="fsToggle">Full Screen</button>
    <button id="drawToggle">‚úèÔ∏è Draw</button>
    <button id="newGame">New Game</button>
  </div>
</header>

<main class="grid" id="grid"></main>

<footer class="store" id="store"><strong>Store:</strong></footer>

<div class="log" id="log"></div>

<!-- Battle stage -->
<div class="stage" id="stage" aria-hidden="true">
  <div class="arena" id="arena">
    <div class="field"></div>

    <div class="stageHUD">
      <div id="hudNames">Attacker ‚Üí Defender</div>
      <div class="stageHP" id="stageHP"><div class="fill" id="stageHPFill" style="width:100%;background:linear-gradient(90deg,#22c55e,#16a34a)"></div></div>
      <div id="shieldHUD" style="min-width:110px;text-align:right;"></div>
    </div>

    <div class="actor att" id="attActor"><div class="sprite" id="attSprite"></div></div>
    <div class="actor def" id="defActor"><div class="sprite" id="defSprite"></div>
      <svg class="shieldIcon" id="shieldIcon" viewBox="0 0 100 100">
        <path d="M50 8 L88 24 V52 C88 72 70 86 50 92 C30 86 12 72 12 52 V24 Z" fill="#7fb0ff" stroke="#193d7a" stroke-width="4"/>
      </svg>
      <svg class="shieldCrack" id="shieldCrack" viewBox="0 0 100 100">
        <path d="M35 10 L60 40 L45 70 L70 90" stroke="#fff" stroke-width="5" fill="none"/>
      </svg>
    </div>

    <div class="narr" id="narr"><div id="nText">.</div><div class="hint">Tap to continue</div></div>
  </div>
</div>

<!-- Annotation layer -->
<canvas id="drawCanvas"></canvas>
<div id="tools" style="display:none;position:fixed;bottom:100px;right:10px;z-index:130;background:rgba(17,24,39,.95);padding:8px;border-radius:10px;gap:8px">
  <button onclick="setColor('red')">Red</button>
  <button onclick="setColor('blue')">Blue</button>
  <button onclick="setColor('black')">Black</button>
  <button onclick="clearCanvas()">Clear</button>
  <button onclick="toggleDraw()">Done</button>
</div>

<script>
/* ================== STATE / SAVE ================== */
const KEY="rpg_pixel_v2";
const PRICES={potion:5, shield:8, poison:7};
const ITEMS=[
  {id:'potion', name:'Potion +10', emoji:'üß™', desc:'Heals 10 & cures poison', cost:PRICES.potion},
  {id:'shield', name:'Shield (10)', emoji:'üõ°Ô∏è', desc:'Adds 10 shield points', cost:PRICES.shield},
  {id:'poison', name:'Poison Arrow', emoji:'üèπ', desc:'Choose target; poisons until cured', cost:PRICES.poison}
];

let state = load() || {
  teams:[ mk('g1','Tanuki','tanuki'), mk('g2','Boar','boar'), mk('g3','Owl','owl'), mk('g4','Cat','cat') ],
  log:[],
  storeSelect:null,
  compact:true
};
function mk(id,name,style){return{ id,name,style, hp:50,maxHp:50, xp:0, next:rand(24,40), level:1,
  money:0, power:0, flags:{poisoned:false,shieldPoints:0}, pack:{potion:0,shield:0,poison:0} };}

function save(){try{localStorage.setItem(KEY,JSON.stringify(state));}catch(e){}}
function load(){try{const s=localStorage.getItem(KEY);return s?JSON.parse(s):null;}catch(e){return null;}}

/* ================== RENDER LIST ================== */
const grid=$('#grid'), logEl=$('#log'), statusEl=$('#status'), storeEl=$('#store');
const compactBtn=$('#compactToggle'), fsBtn=$('#fsToggle');

if(state.compact) document.body.classList.add('compact');
compactBtn.onclick=()=>{ document.body.classList.toggle('compact'); state.compact=document.body.classList.contains('compact'); save(); };

fsBtn.onclick=()=>{
  const el=document.documentElement;
  const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
  const exit = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
  if(!document.fullscreenElement && !document.webkitFullscreenElement){ req && req.call(el); }
  else { exit && exit.call(document); }
};

$('#newGame').onclick=()=>{ if(!confirm('Reset HP/XP/Items/Money?')) return;
  state.teams.forEach(t=>{ t.hp=50;t.maxHp=50;t.xp=0;t.level=1;t.money=0;t.power=0;
    t.flags={poisoned:false,shieldPoints:0}; t.pack={potion:0,shield:0,poison:0}; t.next=rand(24,40); });
  state.log=[]; save(); render();
};
render();

function render(){
  grid.innerHTML='';
  state.teams.forEach(t=>grid.appendChild(card(t)));
  buildStore(); renderLog();
}

function card(t){
  const c=E('div','card'); c.dataset.id=t.id;
  const av=E('div','avatar'); av.innerHTML = sprite16(t.style, t.flags.poisoned, t.power>=100);
  const m=E('div');

  // Editable name
  const nameRow=row();
  const nameInput=document.createElement('input');
  nameInput.value=t.name; nameInput.style.fontSize='16px'; nameInput.style.width='180px';
  nameInput.style.border='1px solid #1f274f'; nameInput.style.background='#0f172a'; nameInput.style.color='var(--text)';
  nameInput.style.borderRadius='8px'; nameInput.style.padding='6px 8px';
  nameInput.onchange=()=>{t.name=nameInput.value.trim()||t.name; save(); render();};
  nameRow.append(E('div','name',''), nameInput);

  const badges=row();
  badges.append(P('Lv '+t.level),
    P(t.flags.poisoned?'Poisoned':'Healthy', t.flags.poisoned?'#84cc16':'#94a3b8'),
    P('Shield '+t.flags.shieldPoints,'#93c5fd'));

  const hpBar=barHP(t.hp/t.maxHp);
  const act=row();
  const atkB=btn('Attack','primary attackBtn',()=>beginAttack(t,atkB));
  const xpB=btn('+XP','',()=>{gainXP(t, randXP()); save(); render();});
  act.append(atkB,xpB);

  const xpBar=barPct((t.xp/t.next)*100,'xpfill');
  const powBar=barPct(t.power,'powfill');
  const shBar=barPct(Math.min(100,t.flags.shieldPoints*10),'shieldfill');

  const money=row(); money.innerHTML=`Money: <strong>$${t.money}</strong>`;
  money.append(btn('+1','btn',()=>{t.money+=1;save();render();}),
               btn('+5','btn',()=>{t.money+=5;save();render();}),
               btn('‚àí1','btn',()=>{t.money=Math.max(0,t.money-1);save();render();}));

  const bag=E('div','bag');
  let k=0;
  if(t.pack.potion>0){ bag.append(bagItem('üß™',`x${t.pack.potion}`,()=>usePotion(t))); k++; }
  if(t.pack.shield>0){ bag.append(bagItem('üõ°Ô∏è',`x${t.pack.shield}`,()=>useShield(t))); k++; }
  if(t.pack.poison>0){ bag.append(bagItem('üèπ',`x${t.pack.poison}`,()=>beginPoison(t))); k++; }
  if(!k) bag.append(E('div','empty','Backpack empty'));

  m.append(nameRow,badges,row(E('div',null,`HP: ${t.hp}/${t.maxHp}`),hpBar),act,row(P('XP'),xpBar),row(P('Attack Power'),powBar),row(P('Shield'),shBar),money,bag);
  c.append(av,m);
  return c;
}

function P(t,color){const s=E('span','pill',t); if(color){s.style.borderColor=color;s.style.color=color;} return s;}
function row(...kids){const d=E('div','row');kids.forEach(k=>d.append(k));return d;}
function barPct(p,cls){const b=E('div','bar');const f=E('div','fill '+cls);f.style.width=Math.max(0,Math.min(100,p))+'%';b.append(f);return b;}
function barHP(p){const b=E('div','bar');const f=E('div','fill');const pct=Math.max(0,Math.min(100,p*100));f.style.width=pct+'%';
  f.style.background= pct<30? 'linear-gradient(90deg,#f87171,#ef4444)'
                    : pct<60? 'linear-gradient(90deg,#f59e0b,#b45309)'
                             : 'linear-gradient(90deg,#22c55e,#16a34a)';
  b.append(f);return b;}
function btn(t,cls,fn){const b=E('button',cls,t);b.onclick=fn;return b;}
function bagItem(e,l,fn){const d=E('div','bagItem');d.innerHTML=`<span>${e}</span><span>${l}</span>`;d.onclick=fn;return d;}
function E(tag,cls,txt){const d=document.createElement(tag);if(cls)d.className=cls;if(txt!=null)d.textContent=txt;return d;}
function $(s){return document.querySelector(s);} function $all(s){return Array.from(document.querySelectorAll(s));}

/* ================== STORE ================== */
function buildStore(){
  storeEl.innerHTML='<strong>Store:</strong> ';
  ITEMS.forEach(it=>{
    const e=E('div','sitem',`${it.emoji} ${it.name} ($${it.cost})`);
    if(state.storeSelect===it.id) e.classList.add('selected');
    e.title=it.desc;
    e.onclick=()=>toggleStoreSelect(it.id);
    storeEl.appendChild(e);
  });
}
function toggleStoreSelect(id){
  state.storeSelect = state.storeSelect===id? null : id;
  setMode(state.storeSelect? 'storeBuy':'idle');
  statusEl.textContent = state.storeSelect? `Selected ${id}. Tap a team to buy.` : 'Ready';
  save(); highlightTargets(state.storeSelect? 'any':'none');
}
function buy(team,itemId){
  const it=ITEMS.find(i=>i.id===itemId); if(!it) return;
  if(team.money<it.cost){statusEl.textContent=`${team.name} needs $${it.cost}`; return;}
  team.money-=it.cost; team.pack[itemId]=(team.pack[itemId]||0)+1;
  logNow(`${team.name} bought ${it.name} for $${it.cost}.`);
  save(); render();
}

/* ================== ITEMS ================== */
function usePotion(t){
  if(t.pack.potion<=0)return;
  t.pack.potion--; const before=t.hp; t.hp=Math.min(t.maxHp,t.hp+10); t.flags.poisoned=false;
  floatPopTeam(t.id, `+${t.hp-before}`, 'popXP', 1700);
  logNow(`${t.name} used Potion (+${t.hp-before}, cured).`); save(); render();
}
function useShield(t){
  if(t.pack.shield<=0)return;
  t.pack.shield--; t.flags.shieldPoints=(t.flags.shieldPoints||0)+10;
  floatPopTeam(t.id, `+Shield 10`, 'popXP', 1700);
  logNow(`${t.name} raised Shield (+10).`); save(); render();
}
function beginPoison(user){
  if(user.pack.poison<=0)return;
  attacker=user; setMode('poisonTarget');
  statusEl.textContent=`${user.name}: choose a target for Poison Arrow`;
  highlightTargets('others', user.id);
  shrinkExcept(user.id,true);
}

/* ================== ATTACK FLOW ================== */
let mode='idle', attacker=null;
function setMode(m){mode=m;}
function beginAttack(user, btnEl){
  attacker=user; setMode('pickTarget');
  btnEl.classList.add('pressed');
  statusEl.textContent=`${user.name}: pick a target`;
  highlightTargets('others', user.id);
  shrinkExcept(user.id,true);
}
grid.addEventListener('click', e=>{
  const card=e.target.closest('.card'); if(!card) return;
  const id=card.dataset.id; const team=state.teams.find(t=>t.id===id);
  if(mode==='storeBuy' && state.storeSelect){ buy(team,state.storeSelect); state.storeSelect=null; setMode('idle'); highlightTargets('none'); return; }
  if(mode==='pickTarget' && attacker && team.id!==attacker.id){
    unshrink(); highlightTargets('none'); setMode('battle'); runBattle(attacker, team); return;
  }
  if(mode==='poisonTarget' && attacker && team.id!==attacker.id){
    unshrink(); highlightTargets('none'); setMode('battle');
    runStage(attacker,team,`Poisoned! ${team.name} will take ‚àí1 each turn.`, {effect:'projectile',damage:0,poison:true})
      .then(()=>{
        attacker.pack.poison--; team.flags.poisoned=true; floatPopTeam(team.id,'‚àí1 (poison start)','popPoison',1700);
        logNow(`${attacker.name} poisoned ${team.name}.`); attacker=null; setMode('idle'); save(); render();
      });
  }
});

/* ================== BATTLE ================== */
function runBattle(att,def){
  lockButtons(true);

  // poison tick for all
  state.teams.forEach(t=>{ if(t.flags.poisoned && t.hp>0) t.hp=Math.max(0,t.hp-1); });

  // damage roll
  let label='HIT', dmg=0, x=Math.random();
  if(x<0.18){label='MISS';dmg=0;} else if(x<0.78){label='HIT';dmg=rand(3,7);} else if(x<0.94){label='HEAVY';dmg=rand(8,13);} else {label='DEVASTATING';dmg=rand(14,20);}
  // power
  const usePow=Math.min(att.power,40);
  if(usePow>0){ const mult=1+(usePow/50); dmg=Math.round(dmg*mult); att.power=Math.max(0,att.power-usePow); label+=' √óPower'; }

  // shield
  let blocked=0;
  if(dmg>0 && def.flags.shieldPoints>0){
    blocked=Math.max(1, Math.floor(Math.random()*Math.min(10,def.flags.shieldPoints)));
    def.flags.shieldPoints=Math.max(0,def.flags.shieldPoints-blocked);
    dmg=Math.max(0,dmg-blocked);
  }

  const resultText = (label.startsWith('MISS'))
    ? `${att.name} missed ‚Äî ${def.name} dodged!`
    : `${att.name} hit ${def.name} for ${dmg}${blocked?` (blocked ${blocked})`:''}.`;

  runStage(att,def,resultText,{effect: (label==='MISS'?'miss':'hit'), damage:dmg, blocked, poisoned:def.flags.poisoned})
    .then(()=>{
      const before=def.hp; def.hp=Math.max(0, def.hp-dmg); const dealt=before-def.hp;
      def.power=Math.min(100, def.power + (dealt>0?22:10));
      let atkXP=dealt>0? 1+Math.floor(dealt/3) : 1; if(Math.random()<.15) atkXP+=2;
      let defXP=1; gainXP(att,atkXP); gainXP(def,defXP);

      floatPopTeam(def.id, dealt?`‚àí${dealt}`:'0', dealt? 'popDmg':'popXP', 1600);
      floatPopTeam(att.id, `+${atkXP} XP`, 'popXP', 1600);
      floatPopTeam(def.id, `+${defXP} XP`, 'popXP', 1600);

      logNow(`${att.name} ‚Üí ${def.name}: ${label} for ${dealt}${blocked?` (blocked ${blocked})`:''}. XP: ${att.name}+${atkXP}, ${def.name}+${defXP}`);

      attacker=null; setMode('idle'); lockButtons(false); save(); render();
    });
}

/* ================== STAGE / ANIMATIONS ================== */
const stage=$('#stage'), attActor=$('#attActor'), defActor=$('#defActor'),
      attSprite=$('#attSprite'), defSprite=$('#defSprite'),
      shieldIcon=$('#shieldIcon'), shieldCrack=$('#shieldCrack'),
      stageHP=$('#stageHP'), stageHPFill=$('#stageHPFill'),
      hudNames=$('#hudNames'), shieldHUD=$('#shieldHUD'),
      nText=$('#nText');

function sprite16(kind, poisoned, charged){
  // 16-bit-ish creatures (SVG composed of blocks). More detail than earlier.
  const P = {
    tanuki:{a:'#c87b3e',b:'#8f562b',c:'#5a351b',eye:'#22150a',acc:'#ffe0a8'},
    boar:  {a:'#9c6a54',b:'#6e4738',c:'#3f2a23',eye:'#1a0e08',acc:'#e8c090'},
    owl:   {a:'#c9b27a',b:'#8a7a4e',c:'#4a4331',eye:'#0f0b06',acc:'#ffd34d'},
    cat:   {a:'#c0c8d8',b:'#8fa0b5',c:'#4b5b6f',eye:'#0b0f13',acc:'#fff1c4'},
  }[kind]||{a:'#c0a0a0',b:'#9a7b7b',c:'#604040',eye:'#111',acc:'#ffd'};
  const tint = poisoned? ' filter="hue-rotate(80deg) saturate(1.2)"' : '';
  return `
  <svg viewBox="0 0 48 48" width="var(--sprite)" height="var(--sprite)" style="image-rendering:pixelated"${tint}>
    <!-- body -->
    <rect x="18" y="22" width="12" height="10" fill="${P.a}"/>
    <rect x="16" y="32" width="16" height="6" fill="${P.a}"/>
    <!-- head -->
    <rect x="14" y="12" width="20" height="12" fill="${P.a}"/>
    <rect x="12" y="10" width="6" height="4" fill="${P.b}"/><rect x="30" y="10" width="6" height="4" fill="${P.b}"/>
    <!-- face -->
    <rect x="18" y="16" width="4" height="3" fill="${P.eye}"/><rect x="26" y="16" width="4" height="3" fill="${P.eye}"/>
    <rect x="22" y="19" width="4" height="2" fill="${P.c}"/>
    <!-- arms -->
    <rect x="12" y="24" width="4" height="6" fill="${P.a}"/><rect x="32" y="24" width="4" height="6" fill="${P.a}"/>
    <!-- legs -->
    <rect x="18" y="38" width="4" height="4" fill="${P.b}"/><rect x="26" y="38" width="4" height="4" fill="${P.b}"/>
    <!-- accessory -->
    <rect x="20" y="28" width="8" height="2" fill="${P.acc}"/>
  </svg>`;
}

async function runStage(att,def,resultLine,opts){
  // Sprites + status
  attSprite.innerHTML = sprite16(att.style, att.flags.poisoned, att.power>=100);
  defSprite.innerHTML = sprite16(def.style, def.flags.poisoned, def.power>=100);

  attSprite.classList.toggle('charged', att.power>=100);
  attSprite.classList.toggle('flame', att.power>=100);
  defSprite.classList.toggle('charged', def.power>=100);
  defSprite.classList.toggle('flame', def.power>=100);

  // shield UI on stage
  if(def.flags.shieldPoints>0){ shieldIcon.classList.add('show'); shieldHUD.textContent = `Shield: ${def.flags.shieldPoints}`; }
  else { shieldIcon.classList.remove('show'); shieldHUD.textContent=''; }

  hudNames.textContent = `${att.name} ‚Üí ${def.name}`;
  const startPct = (def.hp/def.maxHp)*100;
  stageHPFill.style.width = startPct + '%';
  stageHPFill.style.background = hpGrad(startPct);

  stage.classList.add('show');
  await sleep(60);

  // poison flash on defender if poisoned (tick already applied)
  if(opts.poisoned){
    flashTint(defActor, '#7CFC00');
    floatPopAt(defActor, '-1', 'popPoison', 1600);
    await sleep(360);
  }

  if(opts.effect==='miss'){
    // defender dodge (clear, visible)
    const dir = Math.random()<.5? 'dodgeL':'dodgeR';
    defActor.style.animation = (dir==='dodgeL'?'dodgeL':'dodgeR')+' .8s ease';
    await sleep(820);
    defActor.style.animation='';
  } else {
    // attacker runs (with runCycle shimmer)
    attSprite.classList.add('runCycle');
    const rushAnim = (opts.damage>=14? 'rushBig':'rush');
    attActor.style.animation = rushAnim+' 1.15s cubic-bezier(.2,.6,.2,1)';
    await sleep(750);
    // impact
    arenaShake();
    flashTint(defActor, '#ffffff');
    floatPopAt(defActor, `-${opts.damage}${opts.blocked?` (‚àí${opts.blocked})`:''}`, 'popDmg', 1600);
    if(opts.blocked>0){
      shieldCrack.classList.add('show'); await sleep(320); shieldCrack.classList.remove('show');
      if(def.flags.shieldPoints===0){ shieldIcon.classList.remove('show'); floatPopAt(defActor, 'Shield Broken!', 'popDmg', 1600); }
      else { shieldHUD.textContent = `Shield: ${def.flags.shieldPoints}`; }
    }
    await sleep(350);
    attActor.style.animation='';
    attSprite.classList.remove('runCycle');
  }

  // HP bar animates to target width
  const endPct = Math.max(0, Math.min(100, ((def.hp - opts.damage)/def.maxHp)*100 ));
  stageHP.style.animation = 'shake .5s ease';
  await sleep(100);
  stageHPFill.style.width = endPct + '%';
  stageHPFill.style.background = hpGrad(endPct);
  await sleep(900);

  nText.textContent = resultLine;
  await tapToAdvance();
  stage.classList.remove('show');
}

/* helpers */
function hpGrad(pct){return (pct<30)?'linear-gradient(90deg,#f87171,#ef4444)':(pct<60)?'linear-gradient(90deg,#f59e0b,#b45309)':'linear-gradient(90deg,#22c55e,#16a34a)';}
function flashTint(actor,color){const o=document.createElement('div');o.style.position='absolute';o.style.inset='0';o.style.background=color;o.style.opacity='.0';o.style.mixBlendMode='screen';actor.appendChild(o);o.animate([{opacity:.0},{opacity:.55},{opacity:0}],{duration:320}).onfinish=()=>o.remove();}
function arenaShake(){ $('#arena').animate([{transform:'translate(0,0)'},{transform:'translate(-4px,0)'},{transform:'translate(4px,0)'},{transform:'translate(0,0)'}],{duration:280}); }
function floatPopAt(actor,text,cls,dur=1600){const r=actor.getBoundingClientRect();const sp=document.createElement('div');sp.className='hpPop '+cls;sp.textContent=text;sp.style.left=(r.left + r.width/2)+'px';sp.style.top=(r.top + 12)+'px';sp.style.position='fixed';sp.style.fontSize='20px';document.body.appendChild(sp);sp.animate([{transform:'translate(-50%,0)',opacity:1},{transform:'translate(-50%,-30px)',opacity:1},{transform:'translate(-50%,-48px)',opacity:0}],{duration:dur,easing:'ease-out'}).onfinish=()=>sp.remove();}
function floatPopTeam(teamId,text,cls,dur=1600){const card=document.querySelector(`.card[data-id="${teamId}"]`);if(!card)return;const r=card.getBoundingClientRect();const sp=document.createElement('div');sp.className='hpPop '+cls;sp.textContent=text;sp.style.left=(r.left + r.width/2)+'px';sp.style.top=(r.top + 10)+'px';sp.style.position='fixed';sp.style.fontSize='18px';document.body.appendChild(sp);sp.animate([{transform:'translate(-50%,0)',opacity:1},{transform:'translate(-50%,-26px)',opacity:1},{transform:'translate(-50%,-44px)',opacity:0}],{duration:dur,easing:'ease-out'}).onfinish=()=>sp.remove();}
function tapToAdvance(){return new Promise(res=>stage.addEventListener('click',function h(){stage.removeEventListener('click',h);res();},{once:true}))}

/* ================== XP / LOG / UTIL ================== */
function gainXP(t,x){
  const before=t.level;
  t.xp+=x;
  while(t.xp>=t.next){
    t.xp-=t.next; t.level++; t.maxHp+=10; t.hp=Math.min(t.maxHp,t.hp+10);
    t.next=rand(24+t.level*2,45+t.level*3);
  }
  if(t.level>before){ levelUpPopup(t); logNow(`${t.name} leveled up! (Lv ${t.level})`); }
}
function levelUpPopup(t){
  const o=document.createElement('div');
  o.style.position='fixed';o.style.inset='0';o.style.background='rgba(0,0,0,.6)';o.style.zIndex='200';
  o.style.display='flex';o.style.alignItems='center';o.style.justifyContent='center';
  o.innerHTML=`<div style="background:#0f172a;border:1px solid #1f274f;border-radius:14px;padding:18px;min-width:280px;text-align:center">
    <div style="font-size:22px;font-weight:800;margin-bottom:6px">Level Up!</div>
    <div style="font-size:18px;margin-bottom:8px">${t.name} is now <strong>Lv ${t.level}</strong></div>
    <div style="font-size:14px;color:#cbd5e1">Max HP +10, healed a bit!</div>
    <div style="margin-top:12px;font-size:12px;color:#9ca3af">Tap anywhere</div>
  </div>`;
  document.body.appendChild(o);
  o.addEventListener('click',()=>o.remove(),{once:true});
}

function renderLog(){ logEl.innerHTML = state.log.slice(0,200).map(s=>`<div>${esc(s)}</div>`).join(''); }
function logNow(s){ const t=new Date(); const hh=String(t.getHours()).padStart(2,'0'),mm=String(t.getMinutes()).padStart(2,'0'); state.log.unshift(`[${hh}:${mm}] ${s}`); save(); renderLog(); }

function rand(a,b){return a+Math.floor(Math.random()*(b-a+1));}
function randXP(){const x=Math.random();if(x<.06)return 7;if(x<.3)return 3;return 1;}
function esc(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

/* ================== TARGETING HELPERS ================== */
function highlightTargets(kind, excludeId=null){
  $all('.card').forEach(c=>{
    const id=c.dataset.id;
    c.classList.remove('targetable');
    if(kind==='any' || (kind==='others' && id!==excludeId)) c.classList.add('targetable');
  });
}
function shrinkExcept(id,on){$all('.card').forEach(c=>{ if(c.dataset.id!==id){ on?c.classList.add('shrink'):c.classList.remove('shrink'); }});}
function unshrink(){shrinkExcept('',false);}
function lockButtons(on){ $all('button').forEach(b=>b.classList.toggle('disabled',on)); }

/* ================== DRAWING (Pencil smoothing) ================== */
const dC=$('#drawCanvas'), dctx=dC.getContext('2d',{alpha:true,willReadFrequently:true});
let drawOn=false, drawing=false, last={x:0,y:0}, dcolor='red';
function resizeDraw(){ dC.width=innerWidth*2; dC.height=innerHeight*2; dC.style.width='100%'; dC.style.height='100%'; dctx.setTransform(1,0,0,1,0,0); dctx.scale(2,2); }
addEventListener('resize',resizeDraw); resizeDraw();
$('#drawToggle').onclick=toggleDraw;
function toggleDraw(){ drawOn=!drawOn; $('#tools').style.display=drawOn?'flex':'none'; dC.style.pointerEvents=drawOn?'auto':'none'; statusEl.textContent=drawOn?'Annotation mode':'Ready'; }
function setColor(c){dcolor=c;} function clearCanvas(){dctx.clearRect(0,0,dC.width,dC.height);}
dC.addEventListener('pointerdown',e=>{ if(!drawOn)return; drawing=true; dC.setPointerCapture(e.pointerId); last=pt(e); });
dC.addEventListener('pointerup',e=>{ if(!drawOn)return; drawing=false; dC.releasePointerCapture(e.pointerId); });
dC.addEventListener('pointercancel',()=>drawing=false);
dC.addEventListener('pointermove',e=>{
  if(!drawOn||!drawing) return;
  const evs=e.getCoalescedEvents?e.getCoalescedEvents():[e];
  for(const ce of evs){ stroke(last,pt(ce),ce.pressure||1); last=pt(ce); }
});
function stroke(a,b,p){ dctx.strokeStyle=dcolor; dctx.lineWidth=Math.max(2.5,3.8*(p||1)); dctx.lineCap='round'; dctx.lineJoin='round';
  dctx.beginPath(); dctx.moveTo(a.x,a.y); dctx.lineTo(b.x,b.y); dctx.stroke(); }
function pt(e){const r=dC.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top};}
</script>
</body>
</html>
