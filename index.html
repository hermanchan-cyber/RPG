<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Class RPG ‚Äî Ghibli Chibi</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="RPG">
<style>
:root{
  --bg:#0b1220;--panel:#0f172a;--panel2:#111a2e;--text:#e5e7eb;--muted:#9ca3af;
  --primary:#3b82f6;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--border:#1f2937;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,Inter,Roboto,Arial,sans-serif;
     display:grid;grid-template-rows:auto 1fr auto auto;gap:10px;overflow:hidden}
header,footer{background:var(--panel);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;align-items:center;justify-content:space-between}
h1{margin:0;font-size:20px}.status{font-size:14px;color:var(--muted)}
button{border:none;padding:9px 12px;border-radius:12px;background:#334155;color:#fff;font-size:16px}
.primary{background:var(--primary)} .disabled{opacity:.6;pointer-events:none}
.grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:12px;padding:12px}
.card{background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:12px;
      display:grid;grid-template-columns:150px 1fr;gap:12px;transition:transform .25s,outline .2s}
.card.shrink{transform:scale(.92)} .card.targetable{outline:2px solid #7dd3fc}
.avatar{width:150px;height:150px;border-radius:14px;background:#0b1229;border:1px solid #22314f;display:flex;align-items:center;justify-content:center}
.name{font-weight:900;font-size:22px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.hp{font-size:17px}
.bar{height:18px;border-radius:12px;background:#0b1229;border:1px solid #1f274f;overflow:hidden;flex:1}
.fill{height:100%;width:0}
.xpfill{background:linear-gradient(90deg,#93c5fd,#3b82f6)}
.powfill{background:linear-gradient(90deg,#fda4af,#ef4444)}
.shieldfill{background:linear-gradient(90deg,#c7d2fe,#60a5fa)}
.pill{padding:5px 10px;border-radius:999px;background:#0e162b;border:1px solid #1f274f;color:#cbd5e1;font-size:12px}
.bag{display:flex;gap:8px;flex-wrap:wrap;min-height:30px}
.bagItem{display:flex;gap:6px;align-items:center;border:1px dashed #475569;background:#0d162c;padding:6px 10px;border-radius:10px;font-size:14px}
.empty{color:#94a3b8;font-size:13px}
.money .btn{padding:5px 9px;border-radius:10px;background:#1f2937}
.attackBtn.pressed{animation:pulse .7s ease}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,.8)}100%{box-shadow:0 0 0 22px rgba(59,130,246,0)}}
.store{padding:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--panel);border-top:1px solid var(--border)}
.sitem{display:flex;gap:10px;align-items:center;border:1px dashed #3652a1;background:#0e1736;padding:10px 12px;border-radius:12px;font-size:16px}
.sitem.selected{outline:2px solid #7dd3fc}
.log{height:110px;overflow:auto;background:var(--panel);border-top:1px solid var(--border);padding:10px;font-size:14px;color:#cbd5e1}

/* Battle stage */
.stage{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:80}
.stage.show{display:flex}
.arena{width:min(900px,96vw);height:min(520px,68vh);
       background:radial-gradient(circle at 50% 70%, #203a5f 0%, #0b1220 55%, #07101d 100%);
       border:1px solid #1f274f;border-radius:18px;position:relative;overflow:hidden}
.ground{position:absolute;left:0;right:0;bottom:0;height:42%;background:linear-gradient(#0d1b2f,#0a1322)}
.actor{position:absolute;width:160px;height:160px}
.actor.att{left:-190px;bottom:60px}
.actor.def{right:-190px;top:60px}
.actor.in{transition:transform .45s ease,left .45s ease,right .45s ease}
.att.in{left:40px}.def.in{right:40px}
.impact{position:absolute;left:50%;top:46%;transform:translate(-50%,-50%);font-size:64px;opacity:0}
.impact.show{animation:boom .55s ease}
@keyframes boom{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}60%{opacity:1;transform:translate(-50%,-50%) scale(1.25)}100%{opacity:0;transform:translate(-50%,-50%) scale(1)}}
.projectile{position:absolute;width:20px;height:20px;border-radius:50%;background:#60a5fa;box-shadow:0 0 16px #60a5fa;opacity:.95}
.slash{position:absolute;width:150px;height:8px;background:linear-gradient(90deg,#fff,#93c5fd);border-radius:999px;box-shadow:0 0 14px #93c5fd;opacity:.96}
.narr{position:absolute;left:0;right:0;bottom:0;padding:14px;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);
      border-top:1px solid rgba(255,255,255,.08);font-size:18px;text-align:center}
.narr .hint{font-size:12px;color:#cbd5e1}

/* Chibi ‚ÄúGhibli-ish‚Äù SVG bits */
.chibi .arm{transform-origin:20px 20px}
.chibi.wave .arm-l{animation:armwave .45s ease-in-out 2}
.chibi.strike .arm-r{animation:armstrike .28s ease-in-out 1}
@keyframes armwave{0%{transform:rotate(0)}50%{transform:rotate(-22deg)}100%{transform:rotate(0)}}
@keyframes armstrike{0%{transform:rotate(0)}70%{transform:rotate(50deg)}100%{transform:rotate(0)}}

/* Annotation */
#drawCanvas{position:fixed;inset:0;z-index:120;pointer-events:none}
#tools{position:fixed;bottom:110px;right:12px;z-index:130;background:rgba(17,24,39,.95);padding:8px;border-radius:10px;display:none;gap:8px}
#tools button{font-size:14px}
</style>
</head>
<body>
<header>
  <h1>Class RPG ‚Äî Ghibli Chibi</h1>
  <div class="status">Status: <span id="status">Ready</span></div>
  <div style="display:flex;gap:8px">
    <button id="drawToggle">‚úèÔ∏è Draw</button>
    <button id="newGame">New Game</button>
  </div>
</header>

<main class="grid" id="grid"></main>

<footer class="store" id="store"><strong>Store:</strong></footer>
<div class="log" id="log"></div>

<!-- Battle stage -->
<div class="stage" id="stage" aria-hidden="true">
  <div class="arena" id="arena">
    <div class="ground"></div>
    <div class="actor att" id="attSprite"></div>
    <div class="actor def" id="defSprite"></div>
    <div class="impact" id="impact">‚úß</div>
    <div class="narr" id="narr"><div id="nText">.</div><div class="hint">Tap to continue</div></div>
  </div>
</div>

<!-- Annotation layer -->
<canvas id="drawCanvas"></canvas>
<div id="tools">
  <button onclick="setColor('red')">Red</button>
  <button onclick="setColor('blue')">Blue</button>
  <button onclick="setColor('black')">Black</button>
  <button onclick="clearCanvas()">Clear</button>
  <button onclick="toggleDraw()">Done</button>
</div>

<script>
/* ================= STATE / SAVE ================= */
const KEY="rpg_ghibli_v3";
const PRICES={potion:5, shield:8, poison:7};
const ITEMS=[
  {id:'potion', name:'Potion +10', emoji:'üß™', desc:'Heals 10 & cures poison', cost:PRICES.potion},
  {id:'shield', name:'Shield (10)', emoji:'üõ°Ô∏è', desc:'Adds 10 shield points', cost:PRICES.shield},
  {id:'poison', name:'Poison Arrow', emoji:'üèπ', desc:'Choose target; poisons until cured', cost:PRICES.poison}
];

let state = load() || {
  teams:[ mk('g1','Lions','forest'), mk('g2','Bears','samurai'), mk('g3','Wolves','ninja'), mk('g4','Eagles','spirit') ],
  log:[],
  storeSelect:null
};
function mk(id,name,style){return{ id,name,style, hp:50,maxHp:50, xp:0, next:rand(24,40), level:1,
  money:0, power:0, flags:{poisoned:false,shieldPoints:0}, pack:{potion:0,shield:0,poison:0} };}

function save(){try{localStorage.setItem(KEY,JSON.stringify(state));}catch(e){}}
function load(){try{const s=localStorage.getItem(KEY);return s?JSON.parse(s):null;}catch(e){return null;}}

/* ================ RENDER ================== */
const grid=$('#grid'), logEl=$('#log'), statusEl=$('#status'), storeEl=$('#store');
$('#newGame').onclick=()=>{ if(!confirm('Reset HP/XP/Items/Money?')) return;
  state.teams.forEach(t=>{ t.hp=50;t.maxHp=50;t.xp=0;t.level=1;t.money=0;t.power=0;
    t.flags={poisoned:false,shieldPoints:0}; t.pack={potion:0,shield:0,poison:0}; t.next=rand(24,40); });
  state.log=[]; save(); render();
};
render();

function render(){
  grid.innerHTML='';
  state.teams.forEach(t=>grid.appendChild(card(t)));
  buildStore(); renderLog();
}

function card(t){
  const c=E('div','card'); c.dataset.id=t.id;
  const av=E('div','avatar'); av.innerHTML=chibi(t.style);
  const m=E('div');
  const name=E('div','name',t.name);
  const badges=E('div','row');
  badges.append(P('Lv '+t.level),
    P(t.flags.poisoned?'Poisoned':'Healthy', t.flags.poisoned?'#84cc16':'#94a3b8'),
    P('Shield '+t.flags.shieldPoints,'#93c5fd'));
  const r1=row(name,badges);

  const hpTxt=E('div','hp',`HP: ${t.hp}/${t.maxHp}`);
  const hpBar=barHP(t.hp/t.maxHp);
  const r2=row(hpTxt,hpBar);

  const act=row();
  const atkB=btn('Attack','primary attackBtn',()=>beginAttack(t,atkB));
  const xpB=btn('+XP','',()=>{gainXP(t, randXP()); save(); render();});
  act.append(atkB,xpB);

  const xpBar=barPct((t.xp/t.next)*100,'xpfill');
  const r3=row(P('XP'),xpBar);
  const powBar=barPct(t.power,'powfill');
  const r4=row(P('Attack Power'),powBar);
  const shBar=barPct(Math.min(100,t.flags.shieldPoints*10),'shieldfill');
  const r5=row(P('Shield'),shBar);

  const money=row(); money.innerHTML=`Money: <strong>$${t.money}</strong>`;
  money.append(btn('+1','btn',()=>{t.money+=1;save();render();}),
               btn('+5','btn',()=>{t.money+=5;save();render();}),
               btn('‚àí1','btn',()=>{t.money=Math.max(0,t.money-1);save();render();}));

  const bag=E('div','bag');
  let k=0;
  if(t.pack.potion>0){ bag.append(bagItem('üß™',`x${t.pack.potion}`,()=>usePotion(t))); k++; }
  if(t.pack.shield>0){ bag.append(bagItem('üõ°Ô∏è',`x${t.pack.shield}`,()=>useShield(t))); k++; }
  if(t.pack.poison>0){ bag.append(bagItem('üèπ',`x${t.pack.poison}`,()=>beginPoison(t))); k++; }
  if(!k) bag.append(E('div','empty','Backpack empty'));

  m.append(r1,r2,act,r3,r4,r5,money,bag);
  c.append(av,m);
  return c;
}

function row(...kids){const d=E('div','row');kids.forEach(k=>d.append(k));return d;}
function P(t,color){const s=E('span','pill',t); if(color){s.style.borderColor=color;s.style.color=color;} return s;}
function barPct(p,cls){const b=E('div','bar');const f=E('div','fill '+cls);f.style.width=Math.max(0,Math.min(100,p))+'%';b.append(f);return b;}
function barHP(p){const b=E('div','bar');const f=E('div','fill');const pct=Math.max(0,Math.min(100,p*100));f.style.width=pct+'%';
  f.style.background= pct<30? 'linear-gradient(90deg,#f87171,#ef4444)'
                    : pct<60? 'linear-gradient(90deg,#f59e0b,#b45309)'
                             : 'linear-gradient(90deg,#22c55e,#16a34a)';
  b.append(f);return b;}
function btn(t,cls,fn){const b=E('button',cls,t);b.onclick=fn;return b;}
function bagItem(e,l,fn){const d=E('div','bagItem');d.innerHTML=`<span>${e}</span><span>${l}</span>`;d.onclick=fn;return d;}
function E(tag,cls,txt){const d=document.createElement(tag);if(cls)d.className=cls;if(txt!=null)d.textContent=txt;return d;}
function $(sel){return document.querySelector(sel);}

/* ================ STORE ================== */
function buildStore(){
  storeEl.innerHTML='<strong>Store:</strong> ';
  ITEMS.forEach(it=>{
    const e=E('div','sitem',`${it.emoji} ${it.name} ($${it.cost})`);
    if(state.storeSelect===it.id) e.classList.add('selected');
    e.title=it.desc;
    e.onclick=()=>toggleStoreSelect(it.id);
    storeEl.appendChild(e);
  });
}
function toggleStoreSelect(id){
  state.storeSelect = state.storeSelect===id? null : id;
  setMode(state.storeSelect? 'storeBuy':'idle');
  statusEl.textContent = state.storeSelect? `Selected ${id}. Tap a team to buy.` : 'Ready';
  save(); highlightTargets(state.storeSelect? 'any':'none');
}
function buy(team,itemId){
  const it=ITEMS.find(i=>i.id===itemId); if(!it) return;
  if(team.money<it.cost){statusEl.textContent=`${team.name} needs $${it.cost}`; return;}
  team.money-=it.cost; team.pack[itemId]=(team.pack[itemId]||0)+1;
  logNow(`${team.name} bought ${it.name} for $${it.cost}.`);
  save(); render();
}

/* ================ ITEMS ================== */
function usePotion(t){
  if(t.pack.potion<=0)return;
  t.pack.potion--; const before=t.hp; t.hp=Math.min(t.maxHp,t.hp+10); t.flags.poisoned=false;
  logNow(`${t.name} used Potion (+${t.hp-before}, cured).`); save(); render();
}
function useShield(t){
  if(t.pack.shield<=0)return;
  t.pack.shield--; t.flags.shieldPoints=(t.flags.shieldPoints||0)+10;
  logNow(`${t.name} raised Shield (+10).`); save(); render();
}
function beginPoison(user){
  if(user.pack.poison<=0)return;
  attacker=user; setMode('poisonTarget');
  statusEl.textContent=`${user.name}: choose a target for Poison Arrow`;
  highlightTargets('others', user.id);
  shrinkExcept(user.id,true);
}

/* ================ ATTACK FLOW (fixed) ================= */
let mode='idle', attacker=null;
function setMode(m){mode=m;}
function beginAttack(user, btnEl){
  attacker=user; setMode('pickTarget');
  btnEl.classList.add('pressed');
  statusEl.textContent=`${user.name}: pick a target`;
  highlightTargets('others', user.id);
  shrinkExcept(user.id,true);
}
grid.addEventListener('click', e=>{
  const card=e.target.closest('.card'); if(!card) return;
  const id=card.dataset.id; const team=state.teams.find(t=>t.id===id);
  if(mode==='storeBuy' && state.storeSelect){ buy(team,state.storeSelect); state.storeSelect=null; setMode('idle'); highlightTargets('none'); return; }
  if(mode==='pickTarget' && attacker && team.id!==attacker.id){
    unshrink(); highlightTargets('none'); setMode('battle'); runBattle(attacker, team); return;
  }
  if(mode==='poisonTarget' && attacker && team.id!==attacker.id){
    unshrink(); highlightTargets('none'); setMode('battle');
    runStage(attacker,team,[
      `${attacker.name} nocks a shimmering arrow‚Ä¶`,
      `The arrow streaks across the arena!`,
      `${team.name} is now POISONED! (‚àí1 each turn)`
    ],{effect:'projectile',damage:0}).then(()=>{
      attacker.pack.poison--; team.flags.poisoned=true; logNow(`${attacker.name} poisoned ${team.name}.`);
      attacker=null; setMode('idle'); save(); render();
    });
  }
});

function runBattle(att,def){
  lockButtons(true);
  // poison tick for all
  state.teams.forEach(t=>{ if(t.flags.poisoned && t.hp>0) t.hp=Math.max(0,t.hp-1); });

  // damage roll
  let label='HIT', dmg=0, x=Math.random();
  if(x<0.18){label='MISS';dmg=0;} else if(x<0.78){label='HIT';dmg=rand(3,7);} else if(x<0.94){label='HEAVY';dmg=rand(8,13);} else {label='DEVASTATING';dmg=rand(14,20);}
  // power
  const usePow=Math.min(att.power,40);
  if(usePow>0){ const mult=1+(usePow/50); dmg=Math.round(dmg*mult); att.power=Math.max(0,att.power-usePow); label+=' √óPower'; }
  // shield
  if(dmg>0 && def.flags.shieldPoints>0){
    const block=Math.max(1, Math.floor(Math.random()*Math.min(10,def.flags.shieldPoints)));
    def.flags.shieldPoints=Math.max(0,def.flags.shieldPoints-block);
    dmg=Math.max(0,dmg-block); logNow(`${def.name}'s shield blocks ${block}.`);
  }

  const lines=[ `${att.name} steps in and winds up‚Ä¶`,
                (label==='MISS'?'The strike whiffs!':'A clean hit lands!'),
                `${def.name} ${label==='MISS'?'takes no damage.':`takes ${dmg} damage.`}` ];

  runStage(att,def,lines,{effect:(Math.random()<.5?'slash':'projectile'),damage:dmg})
    .then(()=>{
      const before=def.hp; def.hp=Math.max(0,def.hp-dmg); const dealt=before-def.hp;
      def.power=Math.min(100, def.power + (dealt>0?22:10));
      let atkXP=dealt>0? 1+Math.floor(dealt/3) : 1; if(Math.random()<.15) atkXP+=2;
      let defXP=1; gainXP(att,atkXP); gainXP(def,defXP);
      logNow(`${att.name} ‚Üí ${def.name}: ${label} for ${dealt}. XP: ${att.name}+${atkXP}, ${def.name}+${defXP}`);
      attacker=null; setMode('idle'); lockButtons(false); save(); render();
    });
}

function highlightTargets(kind, excludeId=null){
  document.querySelectorAll('.card').forEach(c=>{
    const id=c.dataset.id;
    c.classList.remove('targetable');
    if(kind==='any' || (kind==='others' && id!==excludeId)) c.classList.add('targetable');
  });
}
function shrinkExcept(id,on){document.querySelectorAll('.card').forEach(c=>{ if(c.dataset.id!==id){ on?c.classList.add('shrink'):c.classList.remove('shrink'); }});}
function unshrink(){shrinkExcept('',false);}
function lockButtons(on){ document.querySelectorAll('button').forEach(b=>b.classList.toggle('disabled',on)); }

/* ================= BATTLE STAGE / FX ================= */
const stage=$('#stage'), attSprite=$('#attSprite'), defSprite=$('#defSprite'), impact=$('#impact'), nText=$('#nText');
function chibi(style){
  // ‚ÄúGhibli-ish‚Äù pastel paper-doll: soft fills + ink outline
  const palette={
    forest:{c:'#fce7f3', robe:'#93c5fd'}, samurai:{c:'#fde68a', robe:'#60a5fa'},
    ninja:{c:'#e9d5ff', robe:'#34d399'}, spirit:{c:'#cffafe', robe:'#f472b6'}
  }[style]||{c:'#e5e7eb',robe:'#93c5fd'};
  return `
  <svg class="chibi" viewBox="0 0 130 130" width="130" height="130" aria-hidden="true">
    <defs>
      <filter id="ink" x="-20%" y="-20%" width="140%" height="140%">
        <feTurbulence baseFrequency="0.9" numOctaves="1" result="n"/><feDisplacementMap in="SourceGraphic" in2="n" scale="0.4"/>
      </filter>
    </defs>
    <g filter="url(#ink)" stroke="#0a0a0a" stroke-width="2">
      <circle cx="65" cy="34" r="18" fill="${palette.c}"/>
      <rect x="45" y="52" width="40" height="44" rx="10" fill="${palette.robe}"/>
      <rect class="arm arm-l" x="20" y="55" width="24" height="10" rx="5" fill="${palette.c}"/>
      <rect class="arm arm-r" x="86" y="55" width="24" height="10" rx="5" fill="${palette.c}"/>
      <rect x="52" y="96" width="26" height="20" rx="6" fill="${palette.c}"/>
    </g>
  </svg>`;
}
function sprite(team){const d=document.createElement('div');d.innerHTML=chibi(team.style);const s=d.firstElementChild;return s;}

async function runStage(att,def,lines,opts){
  stage.classList.add('show');
  attSprite.innerHTML=''; defSprite.innerHTML='';
  const A=sprite(att), D=sprite(def);
  A.classList.add('chibi','wave'); D.classList.add('chibi');
  attSprite.appendChild(A); defSprite.appendChild(D);
  attSprite.classList.remove('in'); defSprite.classList.remove('in'); impact.classList.remove('show');
  await sleep(20);
  attSprite.classList.add('in'); defSprite.classList.add('in');
  await sleep(480);

  // FX
  if(opts.effect==='projectile'){ projectileFX(attSprite,defSprite); }
  else { slashFX(attSprite,defSprite); A.classList.add('strike'); }
  await sleep(320);
  if(opts.damage>0){ impact.classList.add('show'); await sleep(540); impact.classList.remove('show'); }

  // Narration (tap to continue each line)
  for(const line of lines){ nText.textContent=line; await tapToAdvance(); }
  stage.classList.remove('show');
}
function tapToAdvance(){return new Promise(res=>stage.addEventListener('click',function h(){stage.removeEventListener('click',h);res();},{once:true}))}
function pos(el){const r=el.getBoundingClientRect();return{x:r.left+r.width/2,y:r.top+r.height/2};}
function projectileFX(from,to){const a=pos(from),b=pos(to),p=document.createElement('div');p.className='projectile';document.body.appendChild(p);
  p.style.left=(a.x-10)+'px';p.style.top=(a.y-10)+'px';
  p.animate([{left:(a.x-10)+'px',top:(a.y-10)+'px',transform:'scale(.7)'},{left:(b.x-10)+'px',top:(b.y-10)+'px',transform:'scale(1.2)'}],
    {duration:280,easing:'cubic-bezier(.2,.6,.2,1)'}).onfinish=()=>p.remove();}
function slashFX(from,to){const b=pos(to),s=document.createElement('div');s.className='slash';s.style.left=(b.x-75)+'px';s.style.top=(b.y-4)+'px';
  document.body.appendChild(s);s.animate([{opacity:0,transform:'scaleX(.4) rotate(15deg)'},{opacity:1,transform:'scaleX(1) rotate(0deg)'}],{duration:220}).onfinish=()=>s.remove();}

/* ================ XP / LOG ================= */
function gainXP(t,x){ t.xp+=x; while(t.xp>=t.next){ t.xp-=t.next; t.level++; t.maxHp+=10; t.hp=Math.min(t.maxHp,t.hp+10);
  t.next=rand(24+t.level*2,45+t.level*3); logNow(`${t.name} leveled up! (Lv ${t.level})`);} }
function renderLog(){ const arr=[...state.log]; logEl.innerHTML=arr.slice(0,180).map(s=>`<div>${esc(s)}</div>`).join(''); }
function logNow(s){ const t=new Date(); const hh=String(t.getHours()).padStart(2,'0'),mm=String(t.getMinutes()).padStart(2,'0'); state.log.unshift(`[${hh}:${mm}] ${s}`); save(); renderLog(); }
function esc(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

/* ================ UTIL ================= */
function rand(a,b){return a+Math.floor(Math.random()*(b-a+1));}
function randXP(){const x=Math.random();if(x<.06)return 7;if(x<.3)return 3;return 1;}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

/* ================ DRAWING (smoothed) ================= */
const dC=$('#drawCanvas'), dctx=dC.getContext('2d',{alpha:true,willReadFrequently:true});
let drawOn=false, drawing=false, last={x:0,y:0}, dcolor='red';
function resizeDraw(){ dC.width=innerWidth*2; dC.height=innerHeight*2; dC.style.width='100%'; dC.style.height='100%'; dctx.setTransform(1,0,0,1,0,0); dctx.scale(2,2); }
addEventListener('resize',resizeDraw); resizeDraw();
$('#drawToggle').onclick=toggleDraw;
function toggleDraw(){ drawOn=!drawOn; $('#tools').style.display=drawOn?'flex':'none'; dC.style.pointerEvents=drawOn?'auto':'none'; statusEl.textContent=drawOn?'Annotation mode':'Ready'; }
function setColor(c){dcolor=c;} function clearCanvas(){dctx.clearRect(0,0,dC.width,dC.height);}
dC.addEventListener('pointerdown',e=>{ if(!drawOn)return; drawing=true; dC.setPointerCapture(e.pointerId); last=pt(e); });
dC.addEventListener('pointerup',e=>{ if(!drawOn)return; drawing=false; dC.releasePointerCapture(e.pointerId); });
dC.addEventListener('pointercancel',()=>drawing=false);
dC.addEventListener('pointermove',e=>{
  if(!drawOn||!drawing) return;
  const evs=e.getCoalescedEvents?e.getCoalescedEvents():[e];
  for(const ce of evs){ stroke(last,pt(ce),ce.pressure||1); last=pt(ce); }
});
function stroke(a,b,p){ dctx.strokeStyle=dcolor; dctx.lineWidth=Math.max(2.5,3.5*(p||1)); dctx.lineCap='round'; dctx.lineJoin='round';
  dctx.beginPath(); dctx.moveTo(a.x,a.y); dctx.lineTo(b.x,b.y); dctx.stroke(); }
function pt(e){const r=dC.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top};}
</script>
</body>
</html>
